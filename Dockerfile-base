FROM python:3.11-slim-bullseye

LABEL authors="alexanderpatrie"

# TODO: make base version more nuanced
ENV BASE_VERSION=latest
ENV BASE_ROOT=ghcr.io/biosimulators/bio-check
ENV BASE_IMAGE="$BASE_VERSION-base:$BASE_VERSION"
ENV DEBIAN_FRONTEND=noninteractive

RUN groupadd -r appgroup \
    && mkdir /app \
    && mkdir /app/bio_check  \
    && mkdir /app/data

WORKDIR /app

COPY bio_check /app/bio_check
COPY pyproject.toml /app/pyproject.toml
COPY poetry.lock /app/poetry.lock
COPY assets/scripts/enter.sh /app/.enter.sh

ENV CRYPTOGRAPHY_DONT_BUILD_RUST=1

# hdf5 deps
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    libc-dev \
    linux-headers-arm64 \
    libjpeg-dev \
    zlib1g-dev \
    libmariadb-dev \
    libffi-dev \
    libopenblas-dev \
    libgfortran5 \
    liblapack-dev \
    build-essential \
    libssl-dev \
    libhdf5-dev \
    pkg-config \
    wget \
    build-essential \
    cmake \
    swig \
    libbz2-dev \
    && apt-get clean  \
    && rm -rf /var/lib/apt/lists/*  \
    && apt-get autoremove -y

ENV PYTHONUNBUFFERED 1

RUN pip install --upgrade pip  \
    && pip install poetry \
    && poetry config virtualenvs.in-project true \
    && poetry update \
    && poetry install --no-cache --no-root --no-interaction \
    && chmod +x /app/.enter.sh

# Set the entrypoint
ENTRYPOINT ["/app/.enter.sh"]

