# FROM python:3.11-slim-bullseye
FROM ghcr.io/biosimulators/biosimulators:latest as base_image

# Install dependencies required for building Python from source
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    wget \
    libssl-dev \
    zlib1g-dev \
    libncurses5-dev \
    libreadline-dev \
    libffi-dev \
    libsqlite3-dev \
    libbz2-dev \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Uninstall existing Python if needed (this step depends on how Python is installed in the base image)
# RUN apt-get remove -y python3.9

# Download and install Python 3.11
RUN wget https://www.python.org/ftp/python/3.11.0/Python-3.11.0.tgz \
    && tar xzf Python-3.11.0.tgz \
    && cd Python-3.11.0 \
    && ./configure --enable-optimizations \
    && make -j $(nproc) \
    && make altinstall \
    && cd .. \
    && rm -rf Python-3.11.0 Python-3.11.0.tgz

# Set the newly installed Python 3.11 as the default python3
RUN update-alternatives --install /usr/bin/python3 python3 /usr/local/bin/python3.11 1

# Install pip for Python 3.11
RUN wget https://bootstrap.pypa.io/get-pip.py \
    && python3.11 get-pip.py \
    && rm get-pip.py

FROM base_image

LABEL authors="alexanderpatrie"

# TODO: make base version more nuanced
ENV PACKAGE_ROOT=ghcr.io/biosimulators/bio-check
ENV BASE_VERSION=0.0.2
ENV BASE_IMAGE="$PACKAGE_ROOT-base:$BASE_VERSION"
ENV DEBIAN_FRONTEND=noninteractive

WORKDIR /app

RUN mkdir /app/bio_check  \
    && mkdir /app/data

# copy deps
COPY ./pyproject.toml ./poetry.lock /app/

# copy package root files
COPY ./bio_check/__init__.py ./bio_check/io.py ./bio_check/database.py ./bio_check/shared.py  /app/bio_check/

# copy entry script
COPY ./assets/scripts/enter.sh /app/.enter.sh

ENV CRYPTOGRAPHY_DONT_BUILD_RUST=1

RUN pip install --upgrade pip  \
    && pip install poetry \
    && poetry config virtualenvs.in-project true \
    && poetry update \
    && echo "bio-check-base" > /app/README.md \
    && poetry install \
    && chmod +x /app/.enter.sh \
    && rm /app/README.md

# Set the entrypoint
ENTRYPOINT ["/app/.enter.sh"]