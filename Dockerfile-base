# This base image is already configured for many purposes LATEST: 0.0.2
FROM ghcr.io/biosimulators/biosimulators:latest

LABEL authors="alexanderpatrie"

ENV DEBIAN_FRONTEND=noninteractive
ENV MONGO_URI="mongodb://mongodb/?retryWrites=true&w=majority&appName=bio-check"
# ENV GOOGLE_APPLICATION_CREDENTIALS=/.google/.bio-check.json

# handle app creds from google
RUN mkdir /.google
COPY ./.bio-check.json /.google/.bio-check.json

# handle main content
WORKDIR /app

RUN mkdir /app/data

# copy deps
COPY ./assets/requirements.base.txt ./assets/scripts/remove_deps.sh ./assets/scripts/update_deps.sh ./assets/dropped.txt /app/assets/
# COPY ./uploads /app/uploads

# copy example files TODO: optimize this.
COPY ./model-examples/sbml-core/Elowitz-Nature-2000-Repressilator.omex /app/data/Elowitz-Nature-2000-Repressilator.omex
COPY ./model-examples/sbml-core/Elowitz-Nature-2000-Repressilator /app/data/Elowitz-Nature-2000-Repressilator

# env specific deps
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    g++ \
    libhdf5-dev \
    libboost-all-dev \
    swig \
    python3-dev \
    libatlas-base-dev \
    libopenblas-dev \
    liblapack-dev \
    && apt-get clean

# Install pipenv and set up environment
RUN pip install pipenv \
    && pipenv install --system --deploy \
    # && pipenv install --skip-lock \
    && pipenv install -r /app/assets/requirements.base.txt

# RUN chmod +x /app/assets/remove_deps.sh \
#     && chmod +x /app/assets/update_deps.sh \
#     && pip install --upgrade pip  \
#     && /app/assets/remove_deps.sh \
#     && pip install --no-cache-dir -r /app/assets/requirements.base.txt \
#     && pip install --upgrade google-cloud-storage

# shared tooling module
# COPY ./assets/shared.py /app/shared.py

# yes | docker system prune -a && yes | docker buildx prune -a \
#   && docker build -f ./Dockerfile-base -t "$PKG_ROOT"-base:"$base_version" . \
#   && docker tag "$PKG_ROOT"-base:"$base_version" "$PKG_ROOT"-base:latest \
#   && docker build -f ./api/Dockerfile-api -t ghcr.io/biosimulators/bio-check-api:0.0.0 ./api \
#   && docker build -f ./worker/Dockerfile-worker -t ghcr.io/biosimulators/bio-check-worker:0.0.0 ./worker


# docker run --name worker --platform linux/amd64 -it ghcr.io/biosimulators/bio-check-worker:0.0.0 \
#   && docker run --name api --platform linux/amd64 -it ghcr.io/biosimulators/bio-check-api:0.0.0